<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News - Delta-Hub Horizon Europe</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="static/css/style.css">
</head>

<body>
    <!-- Header -->
    <header class="bg-eu-blue text-white sticky-top">
        <div class="container">
            <div class="row align-items-center py-3">
                <div class="col-md-8">
                    <div class="d-flex align-items-center">
                        <a href="index.html" class="me-3 d-flex align-items-center" aria-label="Delta-Hub Home">
                            <img src="content/images/Deltahub logo.png" alt="Delta-Hub Logo" class="project-logo">
                        </a>
                        <div>
                            <small class="text-light">Funded by the European Union</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-md-end">
                    <button class="navbar-toggler d-md-none" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarNav">
                        <i class="fas fa-bars text-white"></i>
                    </button>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="navbar navbar-expand-md navbar-dark p-0">
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav w-100">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">
                                <i class="fas fa-home me-1"></i> Home
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="about.html">
                                <i class="fas fa-info-circle me-1"></i> About
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="team.html">
                                <i class="fas fa-users me-1"></i> Our Team
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="research.html">
                                <i class="fas fa-microscope me-1"></i> Research
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="workshops.html">
                                <i class="fas fa-calendar-alt me-1"></i> Workshops
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="news.html">
                                <i class="fas fa-newspaper me-1"></i> News
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-gauge-high me-1"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="contact.html">
                                <i class="fas fa-envelope me-1"></i> Contact
                            </a>
                        </li>

                    </ul>
                </div>
            </nav>
        </div>
    </header>

    <!-- Flash Messages Container -->
    <div id="flashMessages" class="container mt-3"></div>

    <!-- Main Content -->
    <main id="main-content">
        <section class="py-5">
            <div class="container">
                <div class="row">
                    <div class="col-12 text-center mb-5">
                        <h1 class="display-4">Project News</h1>
                        <div class="lead text-muted" data-markdown="content/news/intro.md"></div>
                    </div>
                </div>

                <!-- Quick Add News (no-code) -->
                <div class="row mb-3 d-none" id="adminAddNewsBar">
                    <div class="col-12 text-end">
                        <button class="btn btn-eu-blue" data-bs-toggle="modal" data-bs-target="#addNewsModal">
                            <i class="fas fa-plus me-1"></i>Add News
                        </button>
                        <small class="text-muted ms-2">Saved locally in this browser</small>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div id="newsItemsContainer">
                            <div class="text-center py-5">
                                <i class="fas fa-newspaper fa-5x text-muted mb-4"></i>
                                <h3>No News Available</h3>
                                <p class="text-muted lead">
                                    News updates and announcements will be posted here as they become available.
                                </p>
                                <p class="text-muted">
                                    Check back regularly for the latest information about the Delta-Hub project,
                                    research developments, and upcoming events.
                                </p>
                                <div class="mt-4">
                                    <a href="contact.html" class="btn btn-eu-blue">
                                        <i class="fas fa-envelope me-2"></i>Contact Us for Updates
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Newsletter Subscription -->
                <div class="row mt-5">
                    <div class="col-lg-8 mx-auto">
                        <div class="card bg-gradient-blue text-white">
                            <div class="card-body text-center py-4">
                                <h4 class="mb-3">
                                    <i class="fas fa-envelope me-2"></i>Stay Updated
                                </h4>
                                <p class="mb-4">
                                    Don't miss important project updates, research findings, and event announcements.
                                </p>
                                <div class="row justify-content-center">
                                    <div class="col-md-8">
                                        <div class="input-group">
                                            <input type="email" class="form-control"
                                                placeholder="Enter your email address" id="subscriptionEmail">
                                            <button class="btn btn-light" type="button" id="subscribeBtn">
                                                <i class="fas fa-bell me-1"></i>Subscribe
                                            </button>
                                        </div>
                                        <small class="text-light mt-2 d-block">
                                            We respect your privacy. Unsubscribe at any time.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- News Categories -->
                <div class="row mt-5">
                    <div class="col-12">
                        <h3 class="text-center mb-4">News Categories</h3>
                        <div class="row g-3">
                            <div class="col-md-3 text-center">
                                <div class="p-3 border rounded hover-card">
                                    <i class="fas fa-microscope fa-2x text-primary mb-2"></i>
                                    <h6>Research Updates</h6>
                                    <small class="text-muted">Latest findings and publications</small>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="p-3 border rounded hover-card">
                                    <i class="fas fa-calendar fa-2x text-success mb-2"></i>
                                    <h6>Events</h6>
                                    <small class="text-muted">Workshops and conferences</small>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="p-3 border rounded hover-card">
                                    <i class="fas fa-handshake fa-2x text-warning mb-2"></i>
                                    <h6>Partnerships</h6>
                                    <small class="text-muted">Collaborations and alliances</small>
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="p-3 border rounded hover-card">
                                    <i class="fas fa-award fa-2x text-info mb-2"></i>
                                    <h6>Achievements</h6>
                                    <small class="text-muted">Milestones and recognition</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Add News Modal -->
    <div class="modal fade" id="addNewsModal" tabindex="-1" aria-labelledby="addNewsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addNewsForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addNewsModalLabel"><i class="fas fa-newspaper me-2"></i>Add News
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="newsTitle" class="form-label">Title<span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="newsTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="newsContent" class="form-label">Content</label>
                            <textarea class="form-control" id="newsContent" rows="5"
                                placeholder="Write a short summary..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="newsAuthor" class="form-label">Author</label>
                            <input type="text" class="form-control" id="newsAuthor" placeholder="Your name">
                        </div>
                        <hr>
                        <div class="mb-3">
                            <label for="newsMediaType" class="form-label">Media (optional)</label>
                            <select id="newsMediaType" class="form-select">
                                <option value="none" selected>None</option>
                                <option value="image">Image</option>
                                <option value="video">Video</option>
                            </select>
                        </div>
                        <div id="imageInputs" class="mb-3 d-none">
                            <label class="form-label">Image source</label>
                            <input type="url" class="form-control mb-2" id="newsImageUrl"
                                placeholder="https://... or static/images/example.jpg">
                            <div class="text-center text-muted my-1">— or —</div>
                            <input type="file" class="form-control mb-2" id="newsImageFile" accept="image/*">
                            <div id="imageDropZone" class="rounded text-center p-3 mb-2"
                                style="border:2px dashed #ced4da; background:#f8f9fa; cursor: pointer;">
                                <i class="fas fa-cloud-upload-alt me-1"></i> Drag & drop an image here
                            </div>
                            <div id="imagePreview" class="mt-2 d-none">
                                <img id="imagePreviewImg" class="img-fluid rounded" alt="Preview">
                            </div>
                            <small class="text-muted">Tip: A URL in your repo (e.g., static/images/...) is best for
                                sharing.</small>
                        </div>
                        <div id="videoInputs" class="mb-3 d-none">
                            <label class="form-label">Video source</label>
                            <input type="url" class="form-control mb-2" id="newsVideoUrl"
                                placeholder="https://... or content/videos/example.mp4">
                            <div class="text-center text-muted my-1">— or —</div>
                            <input type="file" class="form-control" id="newsVideoFile" accept="video/*">
                            <small class="text-muted">Large files as uploads will only stay on this device.</small>
                        </div>
                        <div id="repoUploadOptions" class="border rounded p-3 mb-3 d-none">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="uploadToRepo" checked>
                                <label class="form-check-label" for="uploadToRepo">Upload selected file to GitHub
                                    repository</label>
                            </div>
                            <div class="row g-2 align-items-end">
                                <div class="col-md-6">
                                    <label class="form-label" for="ghBranch">Branch</label>
                                    <input type="text" class="form-control" id="ghBranch" value="main">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="ghFolder">Folder</label>
                                    <input type="text" class="form-control" id="ghFolder" value="static/uploads">
                                </div>
                            </div>
                            <small class="text-muted d-block mt-2">Owner/Repo are set to DeltaHUB-UB/website. Change in
                                code if you fork.</small>
                        </div>
                        <small class="text-muted">Note: Items added here are saved to this browser only
                            (localStorage).</small>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-eu-blue">Add</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white mt-5">
        <div class="container py-4">
            <div class="row">
                <div class="col-md-8">
                    <div class="d-flex align-items-center mb-3">
                        <img src="static/images/eu-flag.svg" alt="European Union Flag" class="eu-flag-small me-2">
                        <span>Funded by the European Union</span>
                    </div>
                    <p class="small text-muted">
                        Views and opinions expressed are however those of the author(s) only and do not necessarily
                        reflect those of the European Union or the European Commission. Neither the European Union
                        nor the granting authority can be held responsible for them.
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <h6>Follow Us</h6>
                    <a href="#" class="text-white me-3" aria-label="LinkedIn">
                        <i class="fab fa-linkedin fa-lg"></i>
                    </a>
                    <a href="#" class="text-white" aria-label="Twitter/X">
                        <i class="fab fa-x-twitter fa-lg"></i>
                    </a>
                </div>
            </div>
            <hr class="my-3">
            <div class="text-center">
                <small>&copy; 2025 Delta-Hub Horizon Europe Project. All rights reserved.</small>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="static/js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
    <script src="static/js/markdown.js"></script>
    <script src="static/js/static-data.js"></script>
    <script>
        (function () {
            const ADMIN_KEY = 'dh_is_admin';
            // GitHub config; you may set TOKEN to avoid typing it each time (be careful with public repos)
            const GH = {
                OWNER: 'DeltaHUB-UB',
                REPO: 'website',
                BRANCH: 'main',
                TOKEN: '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', // OPTIONAL: paste your personal access token here to hardcode
                UPLOAD_FOLDER: 'static/uploads',
                NEWS_FOLDER: 'content/news'
            };
            const ADMIN_PASS = 'changeme'; // TODO: change this passcode
            const params = new URLSearchParams(window.location.search);
            const bar = document.getElementById('adminAddNewsBar');
            const form = document.getElementById('addNewsForm');
            const mediaTypeEl = document.getElementById('newsMediaType');
            const imageInputs = document.getElementById('imageInputs');
            const videoInputs = document.getElementById('videoInputs');
            const repoOptions = document.getElementById('repoUploadOptions');
            const uploadToRepoEl = document.getElementById('uploadToRepo');
            const ghBranchEl = document.getElementById('ghBranch');
            const ghFolderEl = document.getElementById('ghFolder');
            const imgFileEl = document.getElementById('newsImageFile');
            const imgUrlEl = document.getElementById('newsImageUrl');
            const imgDrop = document.getElementById('imageDropZone');
            const imgPreviewWrap = document.getElementById('imagePreview');
            const imgPreview = document.getElementById('imagePreviewImg');

            function isAdmin() { return localStorage.getItem(ADMIN_KEY) === '1'; }
            function showBar() { if (bar) bar.classList.remove('d-none'); }
            function hideBar() { if (bar) bar.classList.add('d-none'); }

            function toggleMediaInputs() {
                const v = mediaTypeEl ? mediaTypeEl.value : 'none';
                if (imageInputs) imageInputs.classList.toggle('d-none', v !== 'image');
                if (videoInputs) videoInputs.classList.toggle('d-none', v !== 'video');
                if (repoOptions) repoOptions.classList.toggle('d-none', v === 'none');
            }
            if (mediaTypeEl) mediaTypeEl.addEventListener('change', toggleMediaInputs);
            toggleMediaInputs();

            // Enable/disable admin via URL params
            const adminParam = params.get('admin');
            if (adminParam === '1') {
                const input = prompt('Enter admin passcode:');
                if (input && input === ADMIN_PASS) {
                    localStorage.setItem(ADMIN_KEY, '1');
                    showBar();
                } else {
                    alert('Incorrect passcode.');
                    hideBar();
                }
            } else if (adminParam === 'logout') {
                localStorage.removeItem(ADMIN_KEY);
                hideBar();
            }

            // Show if already admin
            if (isAdmin()) showBar();

            if (!form) return;
            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                if (!isAdmin()) {
                    alert('Admins only. Enable admin mode with ?admin=1');
                    return;
                }
                const title = document.getElementById('newsTitle').value.trim();
                const content = document.getElementById('newsContent').value.trim();
                const author = document.getElementById('newsAuthor').value.trim();
                const mediaType = mediaTypeEl ? mediaTypeEl.value : 'none';
                let extra = {};
                if (mediaType === 'image') {
                    const f = document.getElementById('newsImageFile').files[0];
                    const u = document.getElementById('newsImageUrl').value.trim();
                    let url = '';
                    if (f) {
                        if (uploadToRepoEl && uploadToRepoEl.checked) {
                            url = await uploadFileToRepo(
                                f,
                                getGhToken(),
                                ghBranchEl?.value || GH.BRANCH,
                                ghFolderEl?.value || GH.UPLOAD_FOLDER
                            ).catch(() => '');
                        } else {
                            url = await readAsDataURL(f).catch(() => '');
                        }
                    }
                    else if (u) url = u;
                    if (url) extra.media = { type: 'image', url };
                } else if (mediaType === 'video') {
                    const f = document.getElementById('newsVideoFile').files[0];
                    const u = document.getElementById('newsVideoUrl').value.trim();
                    let url = '';
                    if (f) {
                        if (uploadToRepoEl && uploadToRepoEl.checked) {
                            url = await uploadFileToRepo(
                                f,
                                getGhToken(),
                                ghBranchEl?.value || GH.BRANCH,
                                ghFolderEl?.value || GH.UPLOAD_FOLDER
                            ).catch(() => '');
                        } else {
                            url = await readAsDataURL(f).catch(() => '');
                        }
                    }
                    else if (u) url = u;
                    if (url) extra.media = { type: 'video', url };
                }
                if (!title) return;

                const wantRepo = (uploadToRepoEl && uploadToRepoEl.checked) || !!GH.TOKEN;
                const token = getGhToken();
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0];
                let contentFilePath = '';
                const baseBranch = ghBranchEl?.value || GH.BRANCH;
                const slug = slugify(title);

                if (wantRepo && token) {
                    // Persist token presence flag for UX (no actual token stored unless set earlier)
                    try { if (token && !GH.TOKEN) localStorage.setItem('dh_gh_token', token); } catch { }

                    const newsFolder = (GH.NEWS_FOLDER || 'content/news').replace(/\/$/, '');
                    const mdName = `${dateStr}-${slug}.md`;
                    contentFilePath = `${newsFolder}/${mdName}`;

                    const mediaMdFor = (m) => {
                        if (!m) return '';
                        const url = m.url;
                        if (m.type === 'image') return `![${escapeHtml(title)}](${url})\n\n`;
                        if (m.type === 'video') return `<video controls preload="metadata" style="max-width:100%">\n  <source src="${url}">\n</video>\n\n`;
                        return '';
                    };

                    async function doRepoWrites(targetBranch) {
                        if (extra.media && extra.media.url && extra.media.url.startsWith('data:')) {
                            const fileLike = await dataUrlToFile(extra.media.url, mediaType === 'image' ? 'image.png' : 'video.mp4');
                            const uploadedUrl = await uploadFileToRepo(fileLike, token, targetBranch, ghFolderEl?.value || GH.UPLOAD_FOLDER);
                            extra.media.url = uploadedUrl;
                        }
                        const mdBody = `${mediaMdFor(extra.media)}${content || ''}\n`;
                        await uploadTextFileToRepo(contentFilePath, mdBody, token, targetBranch);
                        const newItem = { id: Date.now(), title, content_file: contentFilePath, date: dateStr, author: author || '' };
                        await appendNewsJson(newItem, token, targetBranch);
                    }

                    try {
                        await doRepoWrites(baseBranch);
                    } catch (err) {
                        const text = (err && err.message) ? err.message : String(err);
                        if (text.includes('403')) {
                            // Fallback: create a branch and open a PR
                            const fbBranch = `news-${dateStr}-${slug}`.slice(0, 120);
                            try {
                                await ensureBranchExists(fbBranch, baseBranch, token);
                                await doRepoWrites(fbBranch);
                                await createPullRequest(`Add news: ${title}`, fbBranch, baseBranch, `Automated news addition for ${dateStr}.`, token);
                                const flash = document.getElementById('flashMessages');
                                if (flash) {
                                    flash.innerHTML = '<div class="alert alert-info alert-dismissible fade show" role="alert">'
                                        + '<i class="fas fa-info-circle me-1"></i>Created a pull request to add your news. Please review and merge it.'
                                        + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>'
                                        + '</div>';
                                }
                            } catch (e2) {
                                console.error('Fallback failed:', e2);
                                alert('Repo update failed (including fallback): ' + ((e2 && e2.message) ? e2.message : String(e2)) + '. The item will be added locally only.');
                            }
                        } else {
                            console.error(err);
                            alert('Repo update failed: ' + text + '. The item will be added locally only.');
                        }
                    }
                }

                if (window.StaticData && typeof window.StaticData.addNewsItem === 'function') {
                    window.StaticData.addNewsItem(title, content, author || '', extra);
                }
                // Close modal
                const modalEl = document.getElementById('addNewsModal');
                if (modalEl) {
                    const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                    modal.hide();
                }
                // Flash message
                const flash = document.getElementById('flashMessages');
                if (flash) {
                    flash.innerHTML = '<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                        '<i class="fas fa-check-circle me-1"></i>News added locally. It will appear in the list below.' +
                        '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                        '</div>';
                }
                form.reset();
                toggleMediaInputs();
                clearPreview();
            });

            // Drag & drop and preview handlers
            function clearPreview() { if (imgPreviewWrap) imgPreviewWrap.classList.add('d-none'); if (imgPreview) imgPreview.src = ''; }
            function showPreview(src) { if (imgPreview) imgPreview.src = src; if (imgPreviewWrap) imgPreviewWrap.classList.remove('d-none'); }
            function isImage(file) { return file && file.type && file.type.startsWith('image/'); }
            if (imgFileEl) imgFileEl.addEventListener('change', async (e) => {
                const f = e.target.files[0];
                if (isImage(f)) { const data = await readAsDataURL(f).catch(() => ''); if (data) showPreview(data); }
            });
            if (imgUrlEl) imgUrlEl.addEventListener('input', () => { const u = imgUrlEl.value.trim(); if (u) showPreview(u); else clearPreview(); });
            if (imgDrop) {
                ['dragenter', 'dragover'].forEach(evt => imgDrop.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); imgDrop.style.background = '#eef5ff'; }));
                ['dragleave', 'drop'].forEach(evt => imgDrop.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); imgDrop.style.background = '#f8f9fa'; }));
                imgDrop.addEventListener('drop', async (e) => {
                    const f = e.dataTransfer.files[0];
                    if (isImage(f)) {
                        if (imgFileEl) { const dt = new DataTransfer(); dt.items.add(f); imgFileEl.files = dt.files; }
                        const data = await readAsDataURL(f).catch(() => ''); if (data) showPreview(data);
                    }
                });
            }

            function readAsDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            function getGhToken() {
                if (GH.TOKEN) return GH.TOKEN;
                try { const saved = localStorage.getItem('dh_gh_token'); if (saved) return saved; } catch { }
                return '';
            }

            async function uploadTextFileToRepo(path, text, token, branch) {
                const base64 = btoa(unescape(encodeURIComponent(text)));
                const apiUrl = `https://api.github.com/repos/${GH.OWNER}/${GH.REPO}/contents/${encodeURIComponent(path)}`;
                const res = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: `Add ${path}`, content: base64, branch: branch || GH.BRANCH })
                });
                if (!res.ok) {
                    const t = await res.text().catch(() => '');
                    throw new Error(`Upload text failed: ${res.status} ${t}`);
                }
                return true;
            }

            async function fetchRepoFile(path, token, branch) {
                const apiUrl = `https://api.github.com/repos/${GH.OWNER}/${GH.REPO}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch || GH.BRANCH)}`;
                const res = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github+json' } });
                if (!res.ok) throw new Error(`Fetch file failed: ${res.status}`);
                const json = await res.json();
                const content = atob(json.content.replace(/\n/g, ''));
                return { text: content, sha: json.sha };
            }

            async function updateRepoFile(path, text, sha, token, branch) {
                const base64 = btoa(unescape(encodeURIComponent(text)));
                const apiUrl = `https://api.github.com/repos/${GH.OWNER}/${GH.REPO}/contents/${encodeURIComponent(path)}`;
                const res = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: `Update ${path}`, content: base64, sha, branch: branch || GH.BRANCH })
                });
                if (!res.ok) {
                    const t = await res.text().catch(() => '');
                    throw new Error(`Update file failed: ${res.status} ${t}`);
                }
                return true;
            }

            async function deleteRepoFile(path, token, branch) {
                // Get file SHA first
                const { sha } = await fetchRepoFile(path, token, branch);
                const apiUrl = `https://api.github.com/repos/${GH.OWNER}/${GH.REPO}/contents/${encodeURIComponent(path)}`;
                const res = await fetch(apiUrl, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github+json', 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `Delete ${path}`, sha, branch: branch || GH.BRANCH })
                });
                if (!res.ok) {
                    const t = await res.text().catch(() => '');
                    throw new Error(`Delete file failed: ${res.status} ${t}`);
                }
                return true;
            }

            async function appendNewsJson(newItem, token, branch) {
                const path = 'data/news.json';
                const maxRetries = 3;
                let attempt = 0;
                while (attempt < maxRetries) {
                    attempt++;
                    let current = [];
                    let sha = undefined;
                    try {
                        const f = await fetchRepoFile(path, token, branch);
                        sha = f.sha; current = JSON.parse(f.text || '[]');
                    } catch {
                        // File may not exist yet; start fresh
                        current = [];
                        sha = undefined;
                    }
                    // Append, de-dup by content_file+title to reduce duplicates on retries
                    current.push(newItem);
                    const seen = new Set();
                    const deduped = current.filter(it => {
                        const key = `${it.content_file || ''}|${it.title || ''}`;
                        if (seen.has(key)) return false; seen.add(key); return true;
                    });
                    const updated = JSON.stringify(deduped, null, 2) + "\n";
                    try {
                        if (sha) {
                            await updateRepoFile(path, updated, sha, token, branch);
                        } else {
                            await uploadTextFileToRepo(path, updated, token, branch);
                        }
                        return true; // success
                    } catch (e) {
                        const msg = (e && e.message) ? e.message : String(e);
                        if (msg.includes('409') && attempt < maxRetries) {
                            // Conflict; retry after short delay
                            await new Promise(r => setTimeout(r, 400 * attempt));
                            continue;
                        }
                        throw e;
                    }
                }
            }

            // Listen for local deletions to optionally sync to repo
            window.addEventListener('dh:news-deleted', async (ev) => {
                try {
                    const token = getGhToken();
                    if (!token) return; // repo deletion requires token
                    const baseBranch = GH.BRANCH;
                    const detail = ev.detail || {};
                    const contentFile = detail.content_file;

                    // Remove content file if present
                    if (contentFile) {
                        try { await deleteRepoFile(contentFile, token, baseBranch); } catch (e) { console.warn('Delete content failed', e); }
                    }

                    // Remove from data/news.json
                    try {
                        const path = 'data/news.json';
                        const { text, sha } = await fetchRepoFile(path, token, baseBranch);
                        const arr = JSON.parse(text || '[]').filter(it => it.content_file !== contentFile && it.title !== detail.title);
                        const updated = JSON.stringify(arr, null, 2) + "\n";
                        await updateRepoFile(path, updated, sha, token, baseBranch);
                    } catch (e) {
                        console.warn('Update news.json failed', e);
                    }
                } catch (err) {
                    console.warn('Repo sync delete skipped/failed:', err);
                }
            });

            function slugify(str) {
                return (str || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '').slice(0, 80);
            }

            async function dataUrlToFile(dataUrl, filename) {
                const arr = dataUrl.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length; const u8 = new Uint8Array(n);
                while (n--) u8[n] = bstr.charCodeAt(n);
                return new File([u8], filename, { type: mime });
            }

            async function uploadFileToRepo(file, token, branch, folder) {
                if (!token) throw new Error('Missing GitHub token');
                // persist token locally if user agrees
                try { if (token) localStorage.setItem('dh_gh_token_present', '1'); } catch { }
                const owner = 'DeltaHUB-UB';
                const repo = 'website';
                const now = new Date();
                const yyyy = now.getFullYear();
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const safeName = (file.name || 'upload.bin').replace(/[^a-zA-Z0-9._-]/g, '_');
                const path = `${folder.replace(/\/$/, '')}/${yyyy}/${mm}/${Date.now()}-${safeName}`;

                const dataUrl = await readAsDataURL(file);
                const base64 = String(dataUrl).split(',')[1];

                const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
                const res = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Add upload ${safeName}`,
                        content: base64,
                        branch: branch || 'main'
                    })
                });
                if (!res.ok) {
                    const msg = await res.text().catch(() => res.statusText);
                    throw new Error(`Upload failed: ${res.status} ${msg}`);
                }
                // Construct raw URL
                const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${branch || 'main'}/${path}`;
                return rawUrl;
            }

            async function ensureBranchExists(newBranch, fromBranch, token) {
                const owner = GH.OWNER; const repo = GH.REPO;
                // Get base branch SHA
                const refUrl = `https://api.github.com/repos/${owner}/${repo}/git/refs/heads/${encodeURIComponent(fromBranch)}`;
                const refRes = await fetch(refUrl, { headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github+json' } });
                if (!refRes.ok) {
                    const t = await refRes.text().catch(() => '');
                    throw new Error(`Get base ref failed: ${refRes.status} ${t}`);
                }
                const refJson = await refRes.json();
                const baseSha = (refJson && refJson.object && refJson.object.sha) ? refJson.object.sha : refJson.sha;
                if (!baseSha) throw new Error('Base SHA not found');
                // Create new branch ref
                const createUrl = `https://api.github.com/repos/${owner}/${repo}/git/refs`;
                const createRes = await fetch(createUrl, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github+json', 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ref: `refs/heads/${newBranch}`, sha: baseSha })
                });
                if (!createRes.ok) {
                    // 422 if already exists; treat as success
                    if (createRes.status !== 422) {
                        const t = await createRes.text().catch(() => '');
                        throw new Error(`Create branch failed: ${createRes.status} ${t}`);
                    }
                }
                return true;
            }

            async function createPullRequest(title, head, base, body, token) {
                const owner = GH.OWNER; const repo = GH.REPO;
                const prUrl = `https://api.github.com/repos/${owner}/${repo}/pulls`;
                const res = await fetch(prUrl, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github+json', 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, head, base, body })
                });
                if (!res.ok) {
                    const t = await res.text().catch(() => '');
                    throw new Error(`Create PR failed: ${res.status} ${t}`);
                }
                return await res.json();
            }
        })();
    </script>
    <script>
        function shareOnTwitter(title) {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(title + ' - Delta-Hub Horizon Europe');
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank', 'width=600,height=400');
        }

        function shareOnLinkedIn(title) {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, '_blank', 'width=600,height=400');
        }
    </script>
</body>

</html>